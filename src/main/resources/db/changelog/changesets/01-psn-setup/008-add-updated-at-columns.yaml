databaseChangeLog:
  - changeSet:
      id: 01-psn-setup/008-add-updated-at-columns
      author: GPT-5.1-Codex-Max
      changes:
        - addColumn:
            schemaName: psn
            tableName: psn_user_profile
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_title
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_user_played_title
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_trophy_set
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_title_trophy_set
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_trophy
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - addColumn:
            schemaName: psn
            tableName: psn_earned_trophy
            columns:
              - column:
                  name: updated_at
                  type: timestamptz
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
        - sql:
            dbms: postgresql
            splitStatements: true
            stripComments: true
            sql: |
              CREATE OR REPLACE FUNCTION psn.set_updated_at()
              RETURNS trigger AS $$
              BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              CREATE TRIGGER trg_psn_user_profile_set_updated_at
              BEFORE UPDATE ON psn.psn_user_profile
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_title_set_updated_at
              BEFORE UPDATE ON psn.psn_title
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_user_played_title_set_updated_at
              BEFORE UPDATE ON psn.psn_user_played_title
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_trophy_set_set_updated_at
              BEFORE UPDATE ON psn.psn_trophy_set
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_title_trophy_set_set_updated_at
              BEFORE UPDATE ON psn.psn_title_trophy_set
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_trophy_set_updated_at
              BEFORE UPDATE ON psn.psn_trophy
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();

              CREATE TRIGGER trg_psn_earned_trophy_set_updated_at
              BEFORE UPDATE ON psn.psn_earned_trophy
              FOR EACH ROW
              EXECUTE FUNCTION psn.set_updated_at();
