name: Deploy TrophyQuest Backend

on:
  push:
    branches: [ main, migration-aws ]
    paths:
      - "src/**"
      - "build.gradle*"
      - "settings.gradle*"
      - "gradlew"
      - "gradle/**"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build Spring Boot jar
        run: ./gradlew clean bootJar

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy jar to EC2
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "Deploying $JAR_FILE"
          scp -i key.pem -o StrictHostKeyChecking=no "$JAR_FILE" \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/trophyquest-backend.jar

      - name: Move jar & restart service on EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
              sudo mv /home/${USER}/trophyquest-backend.jar /opt/trophyquest/trophyquest-backend.jar
              sudo chown trophyquest:trophyquest /opt/trophyquest/trophyquest-backend.jar
              sudo systemctl restart trophyquest-backend
              sudo systemctl status trophyquest-backend --no-pager -l
          EOF
